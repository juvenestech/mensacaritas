<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Presenze Mensa della Caritas</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        --accent: #1f2a44;
        --accent-light: #e2e8f0;
        --border: #1a2a3d;
        --bg: #f4f6fb;
        --text: #1a1f2b;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
      }

      header {
        text-align: center;
        padding: 2.5rem 1.5rem 1rem;
      }

      header h1 {
        margin: 0;
        letter-spacing: 0.12em;
        font-size: clamp(2rem, 3vw + 1rem, 3rem);
        font-weight: 700;
      }

      header p {
        margin: 0.6rem 0 0;
        color: #4a5568;
        font-size: 0.95rem;
      }

      .feedback-banner {
        margin: 1.25rem auto 0;
        max-width: 720px;
        padding: 0.75rem 1.25rem;
        border-radius: 0.65rem;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .feedback-banner.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
      }

      .feedback-banner.success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
      }

      main {
        max-width: 1120px;
        margin: 0 auto;
        padding: 0 1.5rem 3rem;
      }

      .month-section {
        margin-top: 2.5rem;
      }

      .month-name {
        display: inline-block;
        padding: 0.85rem 1.5rem;
        margin-bottom: 1rem;
        background: #fff;
        border: 2px solid var(--border);
        border-radius: 0.65rem;
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: 0.15em;
        text-transform: uppercase;
      }

      .table-wrapper {
        overflow-x: auto;
        border-radius: 1rem;
        box-shadow: 0 18px 35px rgba(15, 23, 42, 0.08);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        min-width: 520px;
      }

      thead th {
        padding: 1rem 0.75rem;
        text-align: center;
        border: 1px solid var(--border);
        text-transform: capitalize;
        font-size: 0.95rem;
        letter-spacing: 0.04em;
      }

      thead tr:first-child th {
        background: var(--accent);
        color: #fff;
        font-weight: 600;
      }

      thead .date-row th {
        background: var(--accent-light);
        color: var(--text);
        font-weight: 600;
        font-size: 1rem;
        text-transform: lowercase;
      }

      tbody td {
        border: 1px solid var(--border);
        padding: 0.75rem 0.75rem;
        min-height: 3.1rem;
        text-align: center;
        font-size: 0.98rem;
        line-height: 1.35;
      }

      tbody td.filled {
        font-weight: 600;
      }

      tbody td.empty {
        background: #f8fafc;
      }

      .add-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2.35rem;
        height: 2.35rem;
        border-radius: 50%;
        border: none;
        background: var(--accent);
        color: #fff;
        font-size: 1.35rem;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .add-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(31, 42, 68, 0.18);
      }

      .add-btn:active {
        transform: scale(0.96);
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }

      @media (max-width: 640px) {
        header h1 {
          letter-spacing: 0.08em;
        }

        thead th,
        tbody td {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>PRESENZE MENSA DELLA CARITAS</h1>
      <p>Accedi con Google per prenotarti come volontario nelle date disponibili.</p>
      <div id="feedback-banner" aria-live="polite"></div>
    </header>
    <main>
      <div id="calendar-root" aria-live="polite"></div>
    </main>
    <script>
      renderFeedbackBanner();

      const calendarRoot = document.getElementById("calendar-root");
      initializeCalendar();

      const GOOGLE_CLIENT_ID =
        "203366866884-nhoh8lhg2j73v1oi5rpp00ru91lulfd1.apps.googleusercontent.com";
      const GOOGLE_SCOPES = "openid email profile";
      const GOOGLE_AUTH_ENDPOINT = "https://accounts.google.com/o/oauth2/v2/auth";
      const GOOGLE_REDIRECT_URI =
        "https://n8nb.lycoris.it/webhook/juvenes/mensacaritas/callback";

      const weekdayFormatter = new Intl.DateTimeFormat("it-IT", {
        weekday: "long"
      });
      const monthFormatter = new Intl.DateTimeFormat("it-IT", {
        month: "long",
        year: "numeric"
      });
      const dateFormatter = new Intl.DateTimeFormat("it-IT", {
        day: "numeric",
        month: "long"
      });

      calendarRoot.addEventListener("click", (event) => {
        const target = event.target.closest(".add-btn");
        if (!target) {
          return;
        }

        const isoDate = target.dataset.date;
        handleAddVolunteer(isoDate);
      });

      async function initializeCalendar() {
        renderPlaceholderMessage("Caricamento disponibilità in corso...");

        try {
          const availabilityData = await fetchAvailabilityData();
          const monthsMap = buildMonthsMap(availabilityData);
          renderCalendar(monthsMap);
        } catch (error) {
          console.error(
            "Errore durante il caricamento delle disponibilità:",
            error
          );
          renderPlaceholderMessage(
            "Non è stato possibile caricare le disponibilità. Riprova più tardi."
          );
        }
      }

      function buildMonthsMap(availabilityData) {
        const monthsMap = new Map();

        for (const entry of availabilityData) {
          if (!entry?.data) {
            continue;
          }

          const date = new Date(`${entry.data}T00:00:00`);
          if (Number.isNaN(date.valueOf())) {
            continue;
          }

          const monthKey = `${date.getFullYear()}-${String(
            date.getMonth() + 1
          ).padStart(2, "0")}`;
          const monthLabel = capitalize(monthFormatter.format(date));

          if (!monthsMap.has(monthKey)) {
            monthsMap.set(monthKey, {
              label: monthLabel,
              days: []
            });
          }

          const maxSlots = Number(entry.n_volontari) || 0;
          const volunteers = [];

          for (let slot = 1; slot <= maxSlots; slot += 1) {
            const parsedVolunteer = parseVolunteerEntry(entry[`volontario_${slot}`]);
            volunteers.push(parsedVolunteer);
          }

          const firstEmptySlotIndex = volunteers.findIndex((name) => !name);

          monthsMap.get(monthKey).days.push({
            isoDate: entry.data,
            weekday: capitalize(weekdayFormatter.format(date)),
            dateDisplay: dateFormatter.format(date),
            volunteers,
            maxSlots,
            firstEmptySlotIndex
          });
        }

        return monthsMap;
      }

      function renderCalendar(monthsMap) {
        calendarRoot.innerHTML = "";

        const orderedMonths = Array.from(monthsMap.entries()).sort((a, b) =>
          a[0].localeCompare(b[0])
        );

        if (!orderedMonths.length) {
          renderPlaceholderMessage(
            "Al momento non ci sono date disponibili per la prenotazione."
          );
          return;
        }

        orderedMonths.forEach(([_, monthData]) => {
          monthData.days.sort((a, b) => a.isoDate.localeCompare(b.isoDate));
          const maxSlots = Math.max(
            ...monthData.days.map((day) => day.maxSlots),
            0
          );

          const section = document.createElement("section");
          section.className = "month-section";

          const title = document.createElement("div");
          title.className = "month-name";
          title.textContent = monthData.label;
          section.appendChild(title);

          const wrapper = document.createElement("div");
          wrapper.className = "table-wrapper";

          const table = document.createElement("table");
          table.setAttribute("role", "grid");

          const thead = document.createElement("thead");
          const weekdayRow = document.createElement("tr");

          monthData.days.forEach((day) => {
            const th = document.createElement("th");
            th.scope = "col";
            th.textContent = day.weekday;
            weekdayRow.appendChild(th);
          });

          const dateRow = document.createElement("tr");
          dateRow.className = "date-row";

          monthData.days.forEach((day) => {
            const th = document.createElement("th");
            th.scope = "col";
            th.textContent = day.dateDisplay;
            dateRow.appendChild(th);
          });

          thead.appendChild(weekdayRow);
          thead.appendChild(dateRow);

          const tbody = document.createElement("tbody");

          for (let slot = 0; slot < maxSlots; slot += 1) {
            const tr = document.createElement("tr");

            monthData.days.forEach((day) => {
              const td = document.createElement("td");
              td.dataset.date = day.isoDate;
              const volunteerEntry = day.volunteers[slot];
              const firstEmptySlotIndex =
                typeof day.firstEmptySlotIndex === "number"
                  ? day.firstEmptySlotIndex
                  : day.volunteers.findIndex((name) => !name);

              if (volunteerEntry) {
                td.classList.add("filled");
                if (volunteerEntry.href) {
                  const link = document.createElement("a");
                  link.href = volunteerEntry.href;
                  link.textContent = volunteerEntry.label;
                  if (!volunteerEntry.href.startsWith("mailto:")) {
                    link.target = "_blank";
                    link.rel = "noopener noreferrer";
                  }
                  td.appendChild(link);
                } else {
                  td.textContent = volunteerEntry.label;
                }
              } else {
                td.classList.add("empty");

                if (slot === firstEmptySlotIndex && firstEmptySlotIndex !== -1) {
                  td.appendChild(createAddButton(day.isoDate));
                }
              }

              tr.appendChild(td);
            });

            tbody.appendChild(tr);
          }

          table.appendChild(thead);
          table.appendChild(tbody);
          wrapper.appendChild(table);
          section.appendChild(wrapper);
          calendarRoot.appendChild(section);
        });
      }

      function handleAddVolunteer(isoDate) {
        redirectToGoogleOAuth(isoDate);
      }

      function capitalize(value) {
        if (!value) return "";
        return value.charAt(0).toUpperCase() + value.slice(1);
      }

      function redirectToGoogleOAuth(isoDate) {
        const statePayload = btoa(
          JSON.stringify({
            date: isoDate
          })
        );

        const params = new URLSearchParams({
          client_id: GOOGLE_CLIENT_ID,
          redirect_uri: GOOGLE_REDIRECT_URI,
          response_type: "code",
          scope: GOOGLE_SCOPES,
          access_type: "online",
          include_granted_scopes: "true",
          prompt: "consent",
          state: statePayload
        });

        const popup = window.open(
          `${GOOGLE_AUTH_ENDPOINT}?${params.toString()}`,
          "oauth-window",
          "width=500,height=600"
        );

        if (!popup) {
          alert(
            "Impossibile aprire la finestra per il login con Google. Controlla che il blocco popup sia disabilitato."
          );
          return;
        }

        const pollingInterval = setInterval(() => {
          if (!popup || popup.closed) {
            clearInterval(pollingInterval);
            initializeCalendar();
          }
        }, 800);
      }

      function createAddButton(isoDate) {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "add-btn";
        button.dataset.date = isoDate;
        button.innerHTML =
          '<span aria-hidden="true">+</span><span class="sr-only">Prenotati per questa data</span>';
        return button;
      }

      function renderFeedbackBanner() {
        const feedbackEl = document.getElementById("feedback-banner");
        if (!feedbackEl) {
          return;
        }

        const params = new URLSearchParams(window.location.search);
        const errorMessage = params.get("error");
        const successMessage = params.get("message");

        feedbackEl.className = "feedback-banner";
        feedbackEl.textContent = "";
        feedbackEl.hidden = true;

        if (errorMessage) {
          feedbackEl.textContent = decodeURIComponent(errorMessage);
          feedbackEl.classList.add("error");
          feedbackEl.hidden = false;
        } else if (successMessage) {
          feedbackEl.textContent = decodeURIComponent(successMessage);
          feedbackEl.classList.add("success");
          feedbackEl.hidden = false;
        }
      }

      function parseVolunteerEntry(rawValue) {
        if (!rawValue) {
          return null;
        }

        const trimmedValue = String(rawValue).trim();
        if (!trimmedValue) {
          return null;
        }

        const hyperlinkMatch = trimmedValue.match(
          /^=HYPERLINK\("([^"]+)"\s*;\s*"([^"]+)"\)$/i
        );

        if (hyperlinkMatch) {
          return {
            label: hyperlinkMatch[2],
            href: hyperlinkMatch[1]
          };
        }

        return {
          label: trimmedValue
        };
      }

      async function fetchAvailabilityData() {
        const endpoint =
          "https://n8nb.lycoris.it/webhook/juvenes/mensacaritas/slots";

        const response = await fetch(endpoint, {
          headers: {
            Accept: "application/json"
          },
          cache: "no-store",
          credentials: "omit"
        });

        if (!response.ok) {
          throw new Error(
            `Risposta non valida dal server (${response.status} ${response.statusText})`
          );
        }

        const contentType = response.headers.get("content-type") || "";

        if (contentType.includes("application/json")) {
          const jsonPayload = await response.json();
          return normalizeAvailabilityPayload(jsonPayload);
        }

        const rawText = await response.text();
        return normalizeAvailabilityPayload(rawText);
      }

      function normalizeAvailabilityPayload(payload) {
        if (!payload) {
          return [];
        }

        if (Array.isArray(payload)) {
          return payload;
        }

        if (typeof payload === "string") {
          const trimmed = payload.trim();
          if (!trimmed) {
            return [];
          }

          const decoded = decodeHtmlEntities(trimmed);

          try {
            return normalizeAvailabilityPayload(JSON.parse(trimmed));
          } catch {
            try {
              return normalizeAvailabilityPayload(JSON.parse(decoded));
            } catch (error) {
              throw new Error("Formato dati non valido: impossibile effettuare il parse.");
            }
          }
        }

        if (Array.isArray(payload.data)) {
          return payload.data;
        }

        return [];
      }

      function renderPlaceholderMessage(message) {
        calendarRoot.innerHTML = `
          <div class="table-wrapper">
            <table role="presentation">
              <tbody>
                <tr>
                  <td style="padding: 1.5rem; text-align: center; font-size: 1rem;">
                    ${message}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }

      function decodeHtmlEntities(value) {
        const element = document.createElement("textarea");
        element.innerHTML = value;
        return element.value;
      }
    </script>
  </body>
</html>
